{"version":3,"file":"index.js","sources":["index.ts"],"sourcesContent":["import {documentEventHandler} from '@sanity/functions'\n\n/**\n * CRITICAL: This Function enforces business rules on ALL writes to productcatalog dataset.\n *\n * Why this matters:\n * - External PIM writes via API (bypasses Studio validation)\n * - Missing allergens = compliance violation & legal liability\n * - Invalid pricing = operational errors & customer complaints\n * - This runs on EVERY write (Studio + API), so PIM cannot bypass rules\n *\n * Demo value: Shows prospect that Functions solve the #1 pain point:\n * \"We can limit business rules via UI, but then it can be bypassed via API.\"\n */\n\ninterface NutritionFacts {\n  calories?: number\n  protein?: number\n  carbs?: number\n  fat?: number\n  sodium?: number\n}\n\ninterface PimMetadata {\n  syncSource?: string\n  syncStatus?: string\n}\n\ninterface ProductDocument {\n  _id: string\n  _type: string\n  sku?: string\n  name?: string\n  category?: string\n  basePrice?: number\n  allergens?: string[]\n  nutritionFacts?: NutritionFacts\n  pimProductId?: string\n  pimMetadata?: PimMetadata\n}\n\ninterface PricingDocument {\n  _id: string\n  _type: string\n  price?: number\n  product?: {_ref: string}\n  storeLocation?: {_ref: string}\n  pricingTier?: string\n}\n\nexport const handler = documentEventHandler(async ({event}) => {\n  const document = event.data?.data || event.data\n  const operation = event.type\n\n  // Only validate creates and updates\n  if (!['document.create', 'document.update'].includes(operation)) {\n    return\n  }\n\n  if (!document || !document._type) {\n    return\n  }\n\n  console.log(`[VALIDATION] ${operation.toUpperCase()} ${document._type} ${document._id}`)\n\n  // Validate products\n  if (document._type === 'product') {\n    await validateProduct(document as ProductDocument)\n  }\n\n  // Validate pricing\n  if (document._type === 'productPricing') {\n    await validatePricing(document as PricingDocument)\n  }\n})\n\nasync function validateProduct(product: ProductDocument): Promise<void> {\n  const errors: string[] = []\n  const warnings: string[] = []\n\n  // ============================================\n  // CRITICAL COMPLIANCE VALIDATIONS\n  // ============================================\n\n  // COMPLIANCE: Allergen information (REQUIRED for FDA compliance)\n  if (!product.allergens || product.allergens.length === 0) {\n    errors.push(\n      '‚ö†Ô∏è COMPLIANCE VIOLATION: Allergen information is REQUIRED for all food products. ' +\n        'This is a legal requirement and cannot be bypassed.',\n    )\n  }\n\n  // COMPLIANCE: Nutrition facts (REQUIRED for FDA compliance)\n  if (!product.nutritionFacts) {\n    errors.push(\n      '‚ö†Ô∏è COMPLIANCE VIOLATION: Nutrition facts are REQUIRED. ' +\n        'Missing this data violates FDA regulations.',\n    )\n  } else {\n    const {calories, protein, carbs, fat, sodium} = product.nutritionFacts\n\n    if (calories && calories > 3000) {\n      warnings.push(\n        '‚ö†Ô∏è WARNING: Calories exceed 3000, which is unusually high. ' +\n          'Please verify this data with PIM source.',\n      )\n    }\n\n    if (calories && protein && carbs && fat) {\n      const calculatedCalories = protein * 4 + carbs * 4 + fat * 9\n      const difference = Math.abs(calories - calculatedCalories)\n\n      if (difference > 100) {\n        warnings.push(\n          `‚ö†Ô∏è WARNING: Calorie calculation (${calculatedCalories}) differs significantly ` +\n            `from stated calories (${calories}). Please verify macronutrients.`,\n        )\n      }\n    }\n\n    if (sodium && sodium > 2300) {\n      warnings.push(\n        '‚ö†Ô∏è WARNING: Sodium exceeds recommended daily value (2300mg). ' +\n          'Consider flagging for customers.',\n      )\n    }\n  }\n\n  // ============================================\n  // DATA QUALITY VALIDATIONS\n  // ============================================\n\n  // VALIDATION: SKU format (must match XX0000 pattern)\n  if (!product.sku) {\n    errors.push('‚ùå REQUIRED: SKU is required for all products')\n  } else if (!/^[A-Z]{2}\\d{4}$/.test(product.sku)) {\n    errors.push(\n      `‚ùå FORMAT ERROR: SKU \"${product.sku}\" is invalid. Must be format XX0000 (e.g., BH1001, CH2001)`,\n    )\n  }\n\n  // VALIDATION: Price range\n  if (product.basePrice !== undefined && product.basePrice !== null) {\n    if (product.basePrice <= 0) {\n      errors.push('‚ùå INVALID: Base price must be greater than $0')\n    }\n    if (product.basePrice > 100) {\n      warnings.push(\n        '‚ö†Ô∏è WARNING: Base price over $100 is unusual for QSR menu items. Please verify with PIM.',\n      )\n    }\n  } else {\n    errors.push('‚ùå REQUIRED: Base price is required')\n  }\n\n  // VALIDATION: Category required\n  if (!product.category) {\n    errors.push('‚ùå REQUIRED: Product must have a category assigned')\n  }\n\n  // VALIDATION: Product name\n  if (!product.name || product.name.trim().length === 0) {\n    errors.push('‚ùå REQUIRED: Product name is required')\n  }\n\n  // ============================================\n  // PIM INTEGRATION VALIDATIONS\n  // ============================================\n\n  if (!product.pimProductId) {\n    warnings.push(\n      '‚ö†Ô∏è WARNING: No PIM Product ID. This product may not be properly synced with external PIM system.',\n    )\n  }\n\n  if (!product.pimMetadata?.syncSource) {\n    warnings.push(\n      '‚ö†Ô∏è WARNING: No sync source identified. Unable to track which PIM system this came from.',\n    )\n  }\n\n  // ============================================\n  // LOGGING & RESPONSE\n  // ============================================\n\n  if (warnings.length > 0) {\n    console.warn('[VALIDATION WARNINGS]', {\n      documentId: product._id,\n      sku: product.sku,\n      name: product.name,\n      warnings,\n      timestamp: new Date().toISOString(),\n    })\n  }\n\n  if (errors.length > 0) {\n    console.error('[VALIDATION FAILURE] Product write REJECTED', {\n      documentId: product._id,\n      sku: product.sku,\n      name: product.name,\n      errors,\n      warnings,\n      timestamp: new Date().toISOString(),\n      source: product.pimMetadata?.syncSource || 'unknown',\n    })\n\n    const errorMessage = [\n      'üö´ PRODUCT VALIDATION FAILED',\n      '',\n      ...errors,\n      '',\n      ...(warnings.length > 0 ? ['Warnings (non-blocking):', ...warnings] : []),\n      '',\n      '---',\n      'This write has been rejected to maintain data quality and compliance.',\n      'Please correct the errors in your PIM system and retry the sync.',\n    ].join('\\n')\n\n    throw new Error(errorMessage)\n  }\n\n  console.log('‚úÖ Product validation PASSED', {\n    sku: product.sku,\n    name: product.name,\n    category: product.category,\n    warnings: warnings.length,\n    timestamp: new Date().toISOString(),\n  })\n}\n\nasync function validatePricing(pricing: PricingDocument): Promise<void> {\n  const errors: string[] = []\n\n  if (pricing.price === undefined || pricing.price === null) {\n    errors.push('‚ùå REQUIRED: Price is required')\n  } else if (pricing.price < 0) {\n    errors.push('‚ùå INVALID: Price cannot be negative')\n  } else if (pricing.price > 100) {\n    errors.push('‚ùå INVALID: Price over $100 is not allowed for QSR menu items')\n  }\n\n  if (!pricing.product) {\n    errors.push('‚ùå REQUIRED: Pricing must reference a product')\n  }\n\n  if (!pricing.storeLocation) {\n    errors.push('‚ùå REQUIRED: Pricing must reference a store location')\n  }\n\n  if (\n    pricing.pricingTier &&\n    !['standard', 'premium', 'value', 'airport'].includes(pricing.pricingTier)\n  ) {\n    errors.push(`‚ùå INVALID: Pricing tier \"${pricing.pricingTier}\" is not recognized`)\n  }\n\n  if (errors.length > 0) {\n    console.error('[VALIDATION FAILURE] Pricing write REJECTED', {\n      documentId: pricing._id,\n      errors,\n      timestamp: new Date().toISOString(),\n    })\n\n    throw new Error(`Pricing validation failed:\\n${errors.join('\\n')}`)\n  }\n\n  console.log('‚úÖ Pricing validation PASSED for', pricing.product?._ref || 'product')\n}\n"],"names":[],"mappings":"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"}